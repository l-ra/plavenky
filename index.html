<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence plaveck√Ωch ƒçip≈Ø</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --danger-color: #dc2626;
            --danger-hover: #b91c1c;
            --success-color: #16a34a;
            --border-color: #e5e7eb;
            --bg-gray: #f9fafb;
            --text-gray: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: #f3f4f6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            color: var(--primary-color);
            text-align: center;
        }

        .menu-toggle {
            display: none;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            margin-bottom: 15px;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .menu-toggle:hover {
            background: var(--primary-hover);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: var(--primary-color);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        input[type="text"],
        input[type="date"],
        input[type="month"],
        select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-hover);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-gray);
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: var(--bg-gray);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestion {
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .autocomplete-suggestion:hover {
            background: var(--bg-gray);
        }

        .chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .chip-tag {
            background: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .chip-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 22px;
            color: #1f2937;
        }

        h3 {
            font-size: 18px;
            color: #1f2937;
            font-weight: 600;
        }

        .filter-section {
            background: var(--bg-gray);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-returned {
            background: #e5e7eb;
            color: #374151;
        }

        @media (min-width: 769px) {
            /* Ensure menu is always visible on desktop */
            .tabs {
                display: flex !important;
                max-height: none !important;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .menu-toggle {
                display: flex;
                width: 100%;
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-in-out;
                margin-bottom: 15px;
                gap: 5px;
            }
            
            .tabs.open {
                max-height: 600px;
            }
            
            .tab-btn {
                width: 100%;
            }
            
            #tab-data-management > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            #tab-data-management > div[style*="grid-template-columns: repeat(3, 1fr)"] {
                grid-template-columns: 1fr !important;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 22px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-gray);
            line-height: 1;
        }

        /* Help/Markdown content styles */
        #help-content {
            max-width: 900px;
            margin: 0 auto;
        }

        #help-content h1 {
            font-size: 32px;
            margin-top: 30px;
            margin-bottom: 20px;
            color: #1f2937;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        #help-content h2 {
            font-size: 24px;
            margin-top: 30px;
            margin-bottom: 15px;
            color: #1f2937;
        }

        #help-content h3 {
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #374151;
        }

        #help-content p {
            margin-bottom: 15px;
            color: #4b5563;
        }

        #help-content ul, #help-content ol {
            margin-bottom: 15px;
            padding-left: 30px;
        }

        #help-content li {
            margin-bottom: 8px;
            color: #4b5563;
        }

        #help-content code {
            background: var(--bg-gray);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #dc2626;
        }

        #help-content pre {
            background: var(--bg-gray);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        #help-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        #help-content strong {
            font-weight: 600;
            color: #1f2937;
        }

        #help-content a {
            color: var(--primary-color);
            text-decoration: none;
        }

        #help-content a:hover {
            text-decoration: underline;
        }

        #help-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 20px;
            margin: 15px 0;
            color: #6b7280;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üèä Evidence plaveck√Ωch ƒçip≈Ø</h1>
            <p style="text-align: center; margin-top: 10px; color: #6b7280; font-size: 14px;">
                Data jsou ulo≈æena pouze na va≈°em poƒç√≠taƒçi v trval√© pamƒõti prohl√≠≈æeƒçe. Data m≈Ø≈æete z√°lohovat na z√°lo≈æce Spr√°va dat.
            </p>
        </div>
    </header>

    <div class="container">
        <button class="menu-toggle" id="menu-toggle">
            <span id="menu-icon">‚ò∞</span>
            <span>Menu</span>
        </button>
        
        <div class="tabs" id="tabs">
            <button class="tab-btn active" data-tab="borrowings">V√Ωp≈Øjƒçky</button>
            <button class="tab-btn" data-tab="new-borrowing">Nov√° v√Ωp≈Øjƒçka</button>
            <button class="tab-btn" data-tab="chips">Spr√°va ƒçip≈Ø</button>
            <button class="tab-btn" data-tab="employees">Spr√°va zamƒõstnanc≈Ø</button>
            <button class="tab-btn" data-tab="export">Export</button>
            <button class="tab-btn" data-tab="data-management">Spr√°va dat</button>
            <button class="tab-btn" data-tab="help">N√°povƒõda</button>
        </div>

        <!-- V√Ωp≈Øjƒçky -->
        <div class="tab-content active" id="tab-borrowings">
            <div class="section-header">
                <h2>Seznam v√Ωp≈Øjƒçek</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="import-borrowings-btn">Importovat XLSX</button>
                    <input type="file" id="import-borrowings" accept=".xlsx" style="display: none;">
                    <button class="btn btn-success" id="export-borrowings-list">Exportovat XLSX</button>
                </div>
            </div>
            
            <!-- Filtry -->
            <div class="filter-section">
                <h3 style="margin-bottom: 15px;">Filtry</h3>
                <div class="form-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filter-employee">Zamƒõstnanec</label>
                        <input type="text" id="filter-employee" placeholder="Jm√©no nebo ƒç√≠slo zamƒõstnance">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filter-department">Odbor</label>
                        <input type="text" id="filter-department" placeholder="N√°zev odboru">
                    </div>
                </div>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filter-chip">ƒåip</label>
                        <input type="text" id="filter-chip" placeholder="Identifik√°tor ƒçipu">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filter-status">Stav</label>
                        <select id="filter-status">
                            <option value="all">V≈°echny</option>
                            <option value="active">Aktivn√≠</option>
                            <option value="ended">Ukonƒçen√©</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" id="clear-filters" style="width: 100%;">Vymazat filtry</button>
                </div>
            </div>
            
            <div id="borrowings-list"></div>
        </div>

        <!-- Nov√° v√Ωp≈Øjƒçka -->
        <div class="tab-content" id="tab-new-borrowing">
            <h2>Nov√° v√Ωp≈Øjƒçka</h2>
            <form id="new-borrowing-form">
                <div class="form-group">
                    <label for="employee-search">Zamƒõstnanec *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="employee-search" placeholder="Zaƒçnƒõte ps√°t jm√©no nebo ƒç√≠slo zamƒõstnance..." required autocomplete="off">
                        <div class="autocomplete-suggestions" id="employee-suggestions"></div>
                    </div>
                    <input type="hidden" id="selected-employee-id">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Datum zaƒç√°tku *</label>
                        <input type="date" id="start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date">Datum konce (voliteln√©)</label>
                        <input type="date" id="end-date">
                    </div>
                </div>

                <div class="form-group">
                    <label for="chip-search">P≈ôidat ƒçip</label>
                    <div class="autocomplete-container">
                        <input type="text" id="chip-search" placeholder="Zaƒçnƒõte ps√°t identifik√°tor ƒçipu..." autocomplete="off">
                        <div class="autocomplete-suggestions" id="chip-suggestions"></div>
                    </div>
                    <div class="chip-list" id="selected-chips"></div>
                </div>

                <button type="submit" class="btn btn-primary">Vytvo≈ôit v√Ωp≈Øjƒçku</button>
            </form>
        </div>

        <!-- Spr√°va ƒçip≈Ø -->
        <div class="tab-content" id="tab-chips">
            <div class="section-header">
                <h2>Spr√°va ƒçip≈Ø</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="import-chips-btn">Importovat XLSX</button>
                    <input type="file" id="import-chips" accept=".xlsx" style="display: none;">
                    <button class="btn btn-success" id="export-chips">Exportovat XLSX</button>
                </div>
            </div>
            
            <form id="add-chip-form" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label for="chip-identifier">Identifik√°tor ƒçipu</label>
                    <input type="text" id="chip-identifier" placeholder="Nap≈ô. CHIP-001" required>
                </div>
                <button type="submit" class="btn btn-primary">P≈ôidat ƒçip</button>
            </form>

            <div id="chips-list"></div>
        </div>

        <!-- Spr√°va zamƒõstnanc≈Ø -->
        <div class="tab-content" id="tab-employees">
            <div class="section-header">
                <h2>Spr√°va zamƒõstnanc≈Ø</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="import-employees-btn">Importovat XLSX</button>
                    <input type="file" id="import-employees" accept=".xlsx" style="display: none;">
                    <button class="btn btn-success" id="export-employees">Exportovat XLSX</button>
                </div>
            </div>
            
            <form id="add-employee-form" style="margin-bottom: 30px;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="employee-name">Jm√©no zamƒõstnance</label>
                        <input type="text" id="employee-name" placeholder="Jan Nov√°k" required>
                    </div>
                    <div class="form-group">
                        <label for="employee-number">Zamƒõstnaneck√© ƒç√≠slo</label>
                        <input type="text" id="employee-number" placeholder="12345" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="employee-department">Odbor</label>
                    <input type="text" id="employee-department" placeholder="V√Ωroba, IT, Administrativa..." required>
                </div>
                <button type="submit" class="btn btn-primary">P≈ôidat zamƒõstnance</button>
            </form>

            <div id="employees-list"></div>
        </div>

        <!-- Export -->
        <div class="tab-content" id="tab-export">
            <div class="section-header">
                <h2>Export v√Ωp≈Øjƒçek</h2>
            </div>
            
            <div class="form-group">
                <label for="export-month">Vyberte mƒõs√≠c</label>
                <input type="month" id="export-month">
            </div>
            <button class="btn btn-success" id="export-borrowings">Exportovat do XLSX</button>
        </div>

        <!-- Spr√°va dat -->
        <div class="tab-content" id="tab-data-management">
            <div class="section-header">
                <h2>Spr√°va dat</h2>
            </div>

            <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                <p style="margin: 0; color: #856404;">
                    <strong>‚ÑπÔ∏è Informace:</strong> Tato funkce umo≈æ≈àuje z√°lohovat v≈°echna data aplikace (ƒçipy, zamƒõstnance a v√Ωp≈Øjƒçky) do jednoho souboru. 
                    Z√°lohu si m≈Ø≈æete st√°hnout a n√°slednƒõ ji obnovit na jin√©m za≈ô√≠zen√≠ nebo prohl√≠≈æeƒçi.
                </p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div style="background: var(--bg-gray); padding: 25px; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">üì• Export dat</h3>
                    <p style="margin-bottom: 20px; color: var(--text-gray);">
                        Exportujte v≈°echna data do souboru JSON. Tento soubor obsahuje ƒçipy, zamƒõstnance a v√Ωp≈Øjƒçky.
                    </p>
                    <button class="btn btn-success" id="export-all-data" style="width: 100%;">
                        Exportovat v≈°echna data
                    </button>
                </div>

                <div style="background: var(--bg-gray); padding: 25px; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">üì§ Import dat</h3>
                    <p style="margin-bottom: 20px; color: var(--text-gray);">
                        Importujte data ze z√°lo≈æn√≠ho souboru JSON. <strong>Pozor:</strong> Tato akce p≈ôep√≠≈°e v≈°echna souƒçasn√° data!
                    </p>
                    <button class="btn btn-primary" id="import-all-data-btn" style="width: 100%;">
                        Importovat data
                    </button>
                    <input type="file" id="import-all-data" accept=".json" style="display: none;">
                </div>
            </div>

            <div style="background: var(--bg-gray); padding: 25px; border-radius: 8px;">
                <h3 style="margin-bottom: 15px;">üóëÔ∏è Smazat v≈°echna data</h3>
                <p style="margin-bottom: 20px; color: var(--text-gray);">
                    Tato akce sma≈æe √∫plnƒõ v≈°echna data z aplikace. Tuto operaci nelze vr√°tit zpƒõt!
                </p>
                <button class="btn btn-danger" id="delete-all-data">
                    Smazat v≈°echna data
                </button>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px;">
                <h3 style="margin-bottom: 10px; color: #1565c0;">üìä Statistiky</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
                    <div>
                        <div style="font-size: 14px; color: var(--text-gray);">Poƒçet ƒçip≈Ø</div>
                        <div style="font-size: 24px; font-weight: bold; color: #1565c0;" id="stats-chips">0</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: var(--text-gray);">Poƒçet zamƒõstnanc≈Ø</div>
                        <div style="font-size: 24px; font-weight: bold; color: #1565c0;" id="stats-employees">0</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: var(--text-gray);">Poƒçet v√Ωp≈Øjƒçek</div>
                        <div style="font-size: 24px; font-weight: bold; color: #1565c0;" id="stats-borrowings">0</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: var(--bg-gray); border-radius: 8px;">
                <h3 style="margin-bottom: 15px;">üìÖ Spr√°va v√Ωp≈Øjƒçek podle mƒõs√≠c≈Ø</h3>
                <p style="margin-bottom: 20px; color: var(--text-gray); font-size: 14px;">
                    Zobrazen√≠ mƒõs√≠c≈Ø, pro kter√© existuj√≠ v√Ωp≈Øjƒçky, a mo≈ænost jejich hromadn√©ho smaz√°n√≠.
                </p>
                <div id="months-overview"></div>
            </div>
        </div>

        <!-- N√°povƒõda -->
        <div class="tab-content" id="tab-help">
            <div class="section-header">
                <h2>N√°povƒõda</h2>
            </div>
            <div id="help-content" style="line-height: 1.8;">
                <p style="text-align: center; color: var(--text-gray);">Naƒç√≠t√°n√≠ n√°povƒõdy...</p>
            </div>
        </div>
    </div>

    <!-- Edit Borrowing Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upravit v√Ωp≈Øjƒçku</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-borrowing-form">
                <input type="hidden" id="edit-borrowing-id">
                
                <div class="form-group">
                    <label for="edit-employee-search">Zamƒõstnanec *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="edit-employee-search" placeholder="Zaƒçnƒõte ps√°t jm√©no nebo ƒç√≠slo zamƒõstnance..." required autocomplete="off">
                        <div class="autocomplete-suggestions" id="edit-employee-suggestions"></div>
                    </div>
                    <input type="hidden" id="edit-selected-employee-id">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-start-date">Datum zaƒç√°tku *</label>
                        <input type="date" id="edit-start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-end-date">Datum konce</label>
                        <input type="date" id="edit-end-date">
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-chip-search">P≈ôidat ƒçip</label>
                    <div class="autocomplete-container">
                        <input type="text" id="edit-chip-search" placeholder="Zaƒçnƒõte ps√°t identifik√°tor ƒçipu..." autocomplete="off">
                        <div class="autocomplete-suggestions" id="edit-chip-suggestions"></div>
                    </div>
                    <div class="chip-list" id="edit-selected-chips"></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Ulo≈æit zmƒõny</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Zru≈°it</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div class="modal" id="edit-employee-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upravit zamƒõstnance</h2>
                <button class="close-modal" onclick="closeEditEmployeeModal()">&times;</button>
            </div>
            <form id="edit-employee-form">
                <input type="hidden" id="edit-employee-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-employee-name">Jm√©no zamƒõstnance</label>
                        <input type="text" id="edit-employee-name" placeholder="Jan Nov√°k" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-number">Zamƒõstnaneck√© ƒç√≠slo</label>
                        <input type="text" id="edit-employee-number" placeholder="12345" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-employee-department">Odbor</label>
                    <input type="text" id="edit-employee-department" placeholder="V√Ωroba, IT, Administrativa..." required>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Ulo≈æit zmƒõny</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditEmployeeModal()">Zru≈°it</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div class="modal" id="custom-dialog-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="dialog-title">Upozornƒõn√≠</h2>
            </div>
            <div id="dialog-content" style="margin-bottom: 20px; line-height: 1.6; white-space: pre-wrap;"></div>
            <div id="dialog-input-container" style="margin-bottom: 20px; display: none;">
                <input type="text" id="dialog-input" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" id="dialog-cancel-btn" style="display: none;">Zru≈°it</button>
                <button class="btn btn-primary" id="dialog-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Load SheetJS library for XLSX support -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Load marked.js library for Markdown support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // Custom Dialog System
        const CustomDialog = {
            alert: function(message, title = 'Upozornƒõn√≠') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('custom-dialog-modal');
                    const titleEl = document.getElementById('dialog-title');
                    const contentEl = document.getElementById('dialog-content');
                    const inputContainer = document.getElementById('dialog-input-container');
                    const okBtn = document.getElementById('dialog-ok-btn');
                    const cancelBtn = document.getElementById('dialog-cancel-btn');
                    
                    titleEl.textContent = title;
                    contentEl.textContent = message;
                    inputContainer.style.display = 'none';
                    cancelBtn.style.display = 'none';
                    okBtn.textContent = 'OK';
                    
                    const handleOk = () => {
                        modal.classList.remove('active');
                        okBtn.removeEventListener('click', handleOk);
                        resolve(true);
                    };
                    
                    okBtn.addEventListener('click', handleOk);
                    modal.classList.add('active');
                    okBtn.focus();
                });
            },
            
            confirm: function(message, title = 'Potvrzen√≠') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('custom-dialog-modal');
                    const titleEl = document.getElementById('dialog-title');
                    const contentEl = document.getElementById('dialog-content');
                    const inputContainer = document.getElementById('dialog-input-container');
                    const okBtn = document.getElementById('dialog-ok-btn');
                    const cancelBtn = document.getElementById('dialog-cancel-btn');
                    
                    titleEl.textContent = title;
                    contentEl.textContent = message;
                    inputContainer.style.display = 'none';
                    cancelBtn.style.display = 'block';
                    okBtn.textContent = 'OK';
                    cancelBtn.textContent = 'Zru≈°it';
                    
                    const handleOk = () => {
                        modal.classList.remove('active');
                        cleanup();
                        resolve(true);
                    };
                    
                    const handleCancel = () => {
                        modal.classList.remove('active');
                        cleanup();
                        resolve(false);
                    };
                    
                    const cleanup = () => {
                        okBtn.removeEventListener('click', handleOk);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    okBtn.addEventListener('click', handleOk);
                    cancelBtn.addEventListener('click', handleCancel);
                    modal.classList.add('active');
                    okBtn.focus();
                });
            },
            
            prompt: function(message, defaultValue = '', title = 'Zadejte hodnotu') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('custom-dialog-modal');
                    const titleEl = document.getElementById('dialog-title');
                    const contentEl = document.getElementById('dialog-content');
                    const inputContainer = document.getElementById('dialog-input-container');
                    const input = document.getElementById('dialog-input');
                    const okBtn = document.getElementById('dialog-ok-btn');
                    const cancelBtn = document.getElementById('dialog-cancel-btn');
                    
                    titleEl.textContent = title;
                    contentEl.textContent = message;
                    inputContainer.style.display = 'block';
                    cancelBtn.style.display = 'block';
                    okBtn.textContent = 'OK';
                    cancelBtn.textContent = 'Zru≈°it';
                    input.value = defaultValue;
                    
                    const handleOk = () => {
                        const value = input.value;
                        modal.classList.remove('active');
                        cleanup();
                        resolve(value);
                    };
                    
                    const handleCancel = () => {
                        modal.classList.remove('active');
                        cleanup();
                        resolve(null);
                    };
                    
                    const handleKeyPress = (e) => {
                        if (e.key === 'Enter') {
                            handleOk();
                        } else if (e.key === 'Escape') {
                            handleCancel();
                        }
                    };
                    
                    const cleanup = () => {
                        okBtn.removeEventListener('click', handleOk);
                        cancelBtn.removeEventListener('click', handleCancel);
                        input.removeEventListener('keypress', handleKeyPress);
                    };
                    
                    okBtn.addEventListener('click', handleOk);
                    cancelBtn.addEventListener('click', handleCancel);
                    input.addEventListener('keypress', handleKeyPress);
                    modal.classList.add('active');
                    
                    // Focus input after modal is visible
                    setTimeout(() => {
                        input.focus();
                        input.select();
                    }, 100);
                });
            }
        };

        // Data Storage
        const Storage = {
            get(key, defaultValue = []) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            },
            set(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            }
        };

        // Analytics & Statistics
        const Analytics = {
            instanceId: null,
            endpoint: null,
            enabled: false,

            // Generate UUID v4
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },

            // Initialize instance ID
            init() {
                // Get or create instance ID (stored separately from app data)
                this.instanceId = localStorage.getItem('analytics_instance_id');
                if (!this.instanceId) {
                    this.instanceId = this.generateUUID();
                    localStorage.setItem('analytics_instance_id', this.instanceId);
                    this.track('first_use', { timestamp: new Date().toISOString() });
                }

                // Load config
                this.loadConfig();
            },

            // Load configuration
            async loadConfig() {
                try {
                    const response = await fetch('config.json');
                    if (response.ok) {
                        const config = await response.json();
                        this.endpoint = config.statsEndpoint;
                        this.enabled = true;
                    } else {
                        throw new Error('Config not found');
                    }
                } catch (error) {
                    // Use default endpoint
                    this.endpoint = 'https://app-stats.apps2.r73.info/plavenky-stat/receive-stats.php';
                    this.enabled = true;
                }
            },

            // Track event
            async track(eventName, eventData = {}) {
                if (!this.enabled || !this.endpoint) {
                    return;
                }

                const payload = {
                    instanceId: this.instanceId,
                    event: eventName,
                    timestamp: new Date().toISOString(),
                    data: eventData
                };

                try {
                    await fetch(this.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                        mode: 'cors'
                    });
                } catch (error) {
                    // Silently fail - don't interrupt user experience
                    console.debug('Analytics tracking failed:', error);
                }
            }
        };

        // Data Management
        let chips = Storage.get('chips', []);
        let employees = Storage.get('employees', []);
        let borrowings = Storage.get('borrowings', []);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize analytics
            Analytics.init();
            
            initializeTabs();
            initializeChips();
            initializeEmployees();
            initializeBorrowings();
            initializeNewBorrowingForm();
            initializeExport();
            initializeEditEmployeeForm();
            initializeDataManagement();
            
            // Set default dates
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = todayStr;
            document.getElementById('end-date').min = todayStr;
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('export-month').value = currentMonth;
        });

        // Tab Navigation
        function initializeTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const menuToggle = document.getElementById('menu-toggle');
            const tabs = document.getElementById('tabs');
            const menuIcon = document.getElementById('menu-icon');

            // Mobile menu toggle
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    tabs.classList.toggle('open');
                    // Change icon
                    menuIcon.textContent = tabs.classList.contains('open') ? '‚úï' : '‚ò∞';
                });
            }

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    
                    // Always close mobile menu (CSS ensures it stays visible on desktop)
                    if (tabs && menuIcon) {
                        tabs.classList.remove('open');
                        menuIcon.textContent = '‚ò∞';
                    }
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                    
                    // Update stats when switching to data management tab
                    if (tabId === 'data-management') {
                        if (typeof updateDataStats === 'function') updateDataStats();
                        if (typeof updateMonthsOverview === 'function') updateMonthsOverview();
                    }
                    
                    // Load help content when switching to help tab
                    if (tabId === 'help') {
                        if (typeof loadHelpContent === 'function') loadHelpContent();
                    }
                });
            });
        }

        // Chips Management
        function initializeChips() {
            const form = document.getElementById('add-chip-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const identifier = document.getElementById('chip-identifier').value.trim();
                
                if (chips.some(c => c.identifier === identifier)) {
                    await CustomDialog.alert('ƒåip s t√≠mto identifik√°torem ji≈æ existuje!');
                    return;
                }
                
                const chip = {
                    id: Date.now(),
                    identifier: identifier
                };
                
                chips.push(chip);
                Storage.set('chips', chips);
                Analytics.track('chip_added', { identifier: identifier });
                form.reset();
                renderChips();
            });
            
            // Import - button triggers file input
            document.getElementById('import-chips-btn').addEventListener('click', () => {
                document.getElementById('import-chips').click();
            });
            document.getElementById('import-chips').addEventListener('change', handleChipImport);
            
            // Export
            document.getElementById('export-chips').addEventListener('click', exportChips);
            
            renderChips();
        }

        function renderChips() {
            const container = document.getElementById('chips-list');
            
            if (chips.length === 0) {
                container.innerHTML = '<div class="empty-state">Zat√≠m nejsou p≈ôid√°ny ≈æ√°dn√© ƒçipy.</div>';
                return;
            }
            
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Identifik√°tor</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${chips.map(chip => `
                            <tr>
                                <td>${chip.identifier}</td>
                                <td>
                                    <button class="btn btn-danger btn-small" onclick="deleteChip(${chip.id})">Smazat</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        async function deleteChip(id) {
            if (!await CustomDialog.confirm('Opravdu chcete smazat tento ƒçip?')) return;
            
            // Check if chip is in any borrowing
            const inUse = borrowings.some(b => b.chips.includes(id));
            if (inUse) {
                await CustomDialog.alert('Tento ƒçip nelze smazat, proto≈æe je pou≈æit ve v√Ωp≈Øjƒçce.');
                return;
            }
            
            chips = chips.filter(c => c.id !== id);
            Storage.set('chips', chips);
            Analytics.track('chip_deleted', { chipId: id });
            renderChips();
        }

        function handleChipImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    let imported = 0;
                    rows.forEach(row => {
                        const identifier = row['Identifik√°tor'] || row['Identifikator'] || row['identifier'] || row['ƒå√≠slo ƒçipu'] || row['Cislo cipu'];
                        
                        if (identifier && !chips.some(c => c.identifier === String(identifier))) {
                            chips.push({
                                id: Date.now() + imported,
                                identifier: String(identifier)
                            });
                            imported++;
                        }
                    });
                    
                    Storage.set('chips', chips);
                    renderChips();
                    Analytics.track('chips_imported', { count: imported });
                    await CustomDialog.alert(`Importov√°no ${imported} ƒçip≈Ø.`);
                } catch (error) {
                    await CustomDialog.alert('Chyba p≈ôi importu souboru: ' + error.message, 'Chyba');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        async function exportChips() {
            if (chips.length === 0) {
                await CustomDialog.alert('Nejsou ≈æ√°dn√© ƒçipy k exportu.');
                return;
            }
            
            const data = chips.map(chip => ({
                'Identifik√°tor': chip.identifier
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ƒåipy');
            XLSX.writeFile(wb, 'cipy.xlsx');
            Analytics.track('chips_exported', { count: chips.length });
        }

        // Employees Management
        function initializeEmployees() {
            const form = document.getElementById('add-employee-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('employee-name').value.trim();
                const number = document.getElementById('employee-number').value.trim();
                const department = document.getElementById('employee-department').value.trim();
                
                if (employees.some(emp => emp.employeeNumber === number)) {
                    await CustomDialog.alert('Zamƒõstnanec s t√≠mto ƒç√≠slem ji≈æ existuje!');
                    return;
                }
                
                const employee = {
                    id: Date.now(),
                    name: name,
                    employeeNumber: number,
                    department: department
                };
                
                employees.push(employee);
                Storage.set('employees', employees);
                Analytics.track('employee_added', { employeeNumber: number });
                form.reset();
                renderEmployees();
            });
            
            // Import - button triggers file input
            document.getElementById('import-employees-btn').addEventListener('click', () => {
                document.getElementById('import-employees').click();
            });
            document.getElementById('import-employees').addEventListener('change', handleEmployeeImport);
            
            // Export
            document.getElementById('export-employees').addEventListener('click', exportEmployees);
            
            renderEmployees();
        }

        function renderEmployees() {
            const container = document.getElementById('employees-list');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state">Zat√≠m nejsou p≈ôid√°ni ≈æ√°dn√≠ zamƒõstnanci.</div>';
                return;
            }
            
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Jm√©no</th>
                            <th>Zamƒõstnaneck√© ƒç√≠slo</th>
                            <th>Odbor</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${employees.map(emp => `
                            <tr>
                                <td>${emp.name}</td>
                                <td>${emp.employeeNumber}</td>
                                <td>${emp.department || '-'}</td>
                                <td>
                                    <div class="actions">
                                        <button class="btn btn-primary btn-small" onclick="editEmployee(${emp.id})">Upravit</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteEmployee(${emp.id})">Smazat</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        async function deleteEmployee(id) {
            if (!await CustomDialog.confirm('Opravdu chcete smazat tohoto zamƒõstnance?')) return;
            
            // Check if employee has any borrowings
            const hasBorowings = borrowings.some(b => b.employeeId === id);
            if (hasBorowings) {
                await CustomDialog.alert('Tohoto zamƒõstnance nelze smazat, proto≈æe m√° v√Ωp≈Øjƒçky.');
                return;
            }
            
            employees = employees.filter(e => e.id !== id);
            Storage.set('employees', employees);
            Analytics.track('employee_deleted', { employeeId: id });
            renderEmployees();
        }

        function editEmployee(id) {
            const employee = employees.find(e => e.id === id);
            if (!employee) return;
            
            document.getElementById('edit-employee-id').value = employee.id;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-number').value = employee.employeeNumber;
            document.getElementById('edit-employee-department').value = employee.department || '';
            
            document.getElementById('edit-employee-modal').classList.add('active');
        }

        function closeEditEmployeeModal() {
            document.getElementById('edit-employee-modal').classList.remove('active');
            document.getElementById('edit-employee-form').reset();
        }

        function initializeEditEmployeeForm() {
            document.getElementById('edit-employee-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('edit-employee-id').value);
                const name = document.getElementById('edit-employee-name').value.trim();
                const number = document.getElementById('edit-employee-number').value.trim();
                const department = document.getElementById('edit-employee-department').value.trim();
                
                // Check if employee number already exists (except for current employee)
                const duplicate = employees.find(emp => emp.employeeNumber === number && emp.id !== id);
                if (duplicate) {
                    await CustomDialog.alert('Zamƒõstnanec s t√≠mto ƒç√≠slem ji≈æ existuje!');
                    return;
                }
                
                const index = employees.findIndex(e => e.id === id);
                if (index !== -1) {
                    employees[index] = {
                        id: id,
                        name: name,
                        employeeNumber: number,
                        department: department
                    };
                    
                    Storage.set('employees', employees);
                    Analytics.track('employee_updated', { employeeId: id });
                    closeEditEmployeeModal();
                    renderEmployees();
                    // Re-render borrowings to update employee info
                    renderBorrowings();
                }
            });
        }


        function handleEmployeeImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    let imported = 0;
                    rows.forEach(row => {
                        const name = row['Jm√©no'] || row['Jmeno'] || row['name'];
                        const number = String(row['Zamƒõstnaneck√© ƒç√≠slo'] || row['Zamestnanecke cislo'] || row['employeeNumber'] || '');
                        const department = row['Odbor'] || row['department'] || '';
                        
                        if (name && number && !employees.some(e => e.employeeNumber === number)) {
                            employees.push({
                                id: Date.now() + imported,
                                name: name,
                                employeeNumber: number,
                                department: department
                            });
                            imported++;
                        }
                    });
                    
                    Storage.set('employees', employees);
                    renderEmployees();
                    Analytics.track('employees_imported', { count: imported });
                    await CustomDialog.alert(`Importov√°no ${imported} zamƒõstnanc≈Ø.`);
                } catch (error) {
                    await CustomDialog.alert('Chyba p≈ôi importu souboru: ' + error.message, 'Chyba');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        async function exportEmployees() {
            if (employees.length === 0) {
                await CustomDialog.alert('Nejsou ≈æ√°dn√≠ zamƒõstnanci k exportu.');
                return;
            }
            
            const data = employees.map(emp => ({
                'Jm√©no': emp.name,
                'Zamƒõstnaneck√© ƒç√≠slo': emp.employeeNumber,
                'Odbor': emp.department || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Zamƒõstnanci');
            XLSX.writeFile(wb, 'zamestnanci.xlsx');
            Analytics.track('employees_exported', { count: employees.length });
        }

        // Autocomplete functionality
        function setupAutocomplete(inputId, suggestionsId, hiddenInputId, getItems, onSelect) {
            const input = document.getElementById(inputId);
            const suggestionsEl = document.getElementById(suggestionsId);
            const hiddenInput = document.getElementById(hiddenInputId);
            
            input.addEventListener('input', () => {
                const value = input.value.toLowerCase().trim();
                
                if (value.length === 0) {
                    suggestionsEl.innerHTML = '';
                    suggestionsEl.style.display = 'none';
                    if (hiddenInput) hiddenInput.value = '';
                    return;
                }
                
                const items = getItems(value);
                
                if (items.length === 0) {
                    suggestionsEl.innerHTML = '';
                    suggestionsEl.style.display = 'none';
                    return;
                }
                
                suggestionsEl.innerHTML = items.map(item => 
                    `<div class="autocomplete-suggestion" data-id="${item.id}">${item.display}</div>`
                ).join('');
                suggestionsEl.style.display = 'block';
                
                suggestionsEl.querySelectorAll('.autocomplete-suggestion').forEach(el => {
                    el.addEventListener('click', () => {
                        const id = parseInt(el.dataset.id);
                        const selectedItem = items.find(i => i.id === id);
                        if (hiddenInput) hiddenInput.value = id;
                        input.value = selectedItem.display;
                        suggestionsEl.style.display = 'none';
                        if (onSelect) onSelect(selectedItem);
                    });
                });
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestionsEl.contains(e.target)) {
                    suggestionsEl.style.display = 'none';
                }
            });
        }

        // New Borrowing Form
        let newBorrowingSelectedChipIds = [];
        
        function initializeNewBorrowingForm() {
            // Employee autocomplete
            setupAutocomplete(
                'employee-search',
                'employee-suggestions',
                'selected-employee-id',
                (value) => employees
                    .filter(e => 
                        e.name.toLowerCase().includes(value) || 
                        e.employeeNumber.toLowerCase().includes(value) ||
                        (e.department && e.department.toLowerCase().includes(value))
                    )
                    .map(e => ({ id: e.id, display: `${e.name} (${e.employeeNumber}) - ${e.department || 'Bez odboru'}` })),
                null
            );
            
            // Chip autocomplete with availability check
            const chipSearchInput = document.getElementById('chip-search');
            const chipSuggestionsEl = document.getElementById('chip-suggestions');
            const selectedChipsContainer = document.getElementById('selected-chips');
            
            chipSearchInput.addEventListener('input', () => {
                const value = chipSearchInput.value.toLowerCase().trim();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value || startDate;
                
                if (value.length === 0) {
                    chipSuggestionsEl.innerHTML = '';
                    chipSuggestionsEl.style.display = 'none';
                    return;
                }
                
                const availableChips = getAvailableChips(startDate, endDate, newBorrowingSelectedChipIds);
                const filtered = availableChips.filter(c => 
                    c.identifier.toLowerCase().includes(value) && 
                    !newBorrowingSelectedChipIds.includes(c.id)
                );
                
                if (filtered.length === 0) {
                    chipSuggestionsEl.innerHTML = '';
                    chipSuggestionsEl.style.display = 'none';
                    return;
                }
                
                chipSuggestionsEl.innerHTML = filtered.map(chip => 
                    `<div class="autocomplete-suggestion" data-id="${chip.id}">${chip.identifier}</div>`
                ).join('');
                chipSuggestionsEl.style.display = 'block';
                
                chipSuggestionsEl.querySelectorAll('.autocomplete-suggestion').forEach(el => {
                    el.addEventListener('click', () => {
                        const chipId = parseInt(el.dataset.id);
                        addChipToNewBorrowingSelection(chipId);
                        chipSearchInput.value = '';
                        chipSuggestionsEl.style.display = 'none';
                    });
                });
            });
            
            document.addEventListener('click', (e) => {
                if (!chipSearchInput.contains(e.target) && !chipSuggestionsEl.contains(e.target)) {
                    chipSuggestionsEl.style.display = 'none';
                }
            });
            
            // Date validation for new borrowing
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            // Update min attribute on end date when start date changes
            startDateInput.addEventListener('change', () => {
                if (startDateInput.value) {
                    endDateInput.min = startDateInput.value;
                    // Clear end date if it's now invalid
                    if (endDateInput.value && new Date(endDateInput.value) < new Date(startDateInput.value)) {
                        endDateInput.value = '';
                    }
                }
            });
            
            endDateInput.addEventListener('change', async () => {
                if (startDateInput.value && endDateInput.value) {
                    if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
                        await CustomDialog.alert('Datum konce mus√≠ b√Ωt stejn√© nebo pozdƒõj≈°√≠ ne≈æ datum zaƒç√°tku.');
                        endDateInput.value = '';
                    }
                }
            });
            
            // Form submission
            document.getElementById('new-borrowing-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const employeeId = parseInt(document.getElementById('selected-employee-id').value);
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value || null;
                
                if (!employeeId) {
                    await CustomDialog.alert('Vyberte zamƒõstnance.');
                    return;
                }
                
                if (newBorrowingSelectedChipIds.length === 0) {
                    await CustomDialog.alert('P≈ôidejte alespo≈à jeden ƒçip.');
                    return;
                }
                
                if (endDate && new Date(endDate) < new Date(startDate)) {
                    await CustomDialog.alert('Datum konce mus√≠ b√Ωt stejn√© nebo pozdƒõj≈°√≠ ne≈æ datum zaƒç√°tku.');
                    return;
                }
                
                const borrowing = {
                    id: Date.now(),
                    employeeId: employeeId,
                    chips: [...newBorrowingSelectedChipIds],
                    startDate: startDate,
                    endDate: endDate
                };
                
                borrowings.push(borrowing);
                Storage.set('borrowings', borrowings);
                Analytics.track('borrowing_created', { chipsCount: newBorrowingSelectedChipIds.length });
                
                // Reset form
                document.getElementById('new-borrowing-form').reset();
                document.getElementById('selected-employee-id').value = '';
                const todayStr = new Date().toISOString().split('T')[0];
                document.getElementById('start-date').value = todayStr;
                document.getElementById('end-date').min = todayStr;
                newBorrowingSelectedChipIds = [];
                selectedChipsContainer.innerHTML = '';
                
                await CustomDialog.alert('V√Ωp≈Øjƒçka byla vytvo≈ôena.');
                
                // Switch to borrowings tab
                document.querySelector('[data-tab="borrowings"]').click();
                renderBorrowings();
            });
        }

        function addChipToNewBorrowingSelection(chipId) {
            if (newBorrowingSelectedChipIds.includes(chipId)) return;
            
            newBorrowingSelectedChipIds.push(chipId);
            const chip = chips.find(c => c.id === chipId);
            const container = document.getElementById('selected-chips');
            
            const tag = document.createElement('div');
            tag.className = 'chip-tag';
            tag.innerHTML = `
                ${chip.identifier}
                <button type="button" onclick="removeChipFromNewBorrowingSelection(${chipId}, this)">&times;</button>
            `;
            container.appendChild(tag);
        }

        function removeChipFromNewBorrowingSelection(chipId, button) {
            newBorrowingSelectedChipIds = newBorrowingSelectedChipIds.filter(id => id !== chipId);
            button.closest('.chip-tag').remove();
        }

        function removeChipFromSelection(chipId, button) {
            editSelectedChipIds = editSelectedChipIds.filter(id => id !== chipId);
            button.closest('.chip-tag').remove();
        }

        function getAvailableChips(startDate, endDate, excludeChipIds = [], excludeBorrowingId = null) {
            if (!startDate) return chips;
            
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date(startDate);
            
            return chips.filter(chip => {
                if (excludeChipIds.includes(chip.id)) return false;
                
                // Check if chip is borrowed during this period
                const isBooked = borrowings.some(b => {
                    if (excludeBorrowingId && b.id === excludeBorrowingId) return false;
                    if (!b.chips.includes(chip.id)) return false;
                    
                    const bStart = new Date(b.startDate);
                    const bEnd = b.endDate ? new Date(b.endDate) : new Date(b.startDate);
                    
                    // Check overlap
                    return start <= bEnd && end >= bStart;
                });
                
                return !isBooked;
            });
        }

        // Borrowings Management
        function initializeBorrowings() {
            renderBorrowings();
            
            // Setup filter listeners
            document.getElementById('filter-employee').addEventListener('input', renderBorrowings);
            document.getElementById('filter-department').addEventListener('input', renderBorrowings);
            document.getElementById('filter-chip').addEventListener('input', renderBorrowings);
            document.getElementById('filter-status').addEventListener('change', renderBorrowings);
            document.getElementById('clear-filters').addEventListener('click', () => {
                document.getElementById('filter-employee').value = '';
                document.getElementById('filter-department').value = '';
                document.getElementById('filter-chip').value = '';
                document.getElementById('filter-status').value = 'all';
                renderBorrowings();
            });
            
            // Import/Export listeners
            document.getElementById('import-borrowings-btn').addEventListener('click', () => {
                document.getElementById('import-borrowings').click();
            });
            document.getElementById('import-borrowings').addEventListener('change', handleBorrowingsImport);
            document.getElementById('export-borrowings-list').addEventListener('click', exportBorrowingsList);
        }

        function renderBorrowings() {
            const container = document.getElementById('borrowings-list');
            
            if (borrowings.length === 0) {
                container.innerHTML = '<div class="empty-state">Zat√≠m nejsou ≈æ√°dn√© v√Ωp≈Øjƒçky.</div>';
                return;
            }
            
            // Get filter values
            const filterEmployee = document.getElementById('filter-employee').value.toLowerCase().trim();
            const filterDepartment = document.getElementById('filter-department').value.toLowerCase().trim();
            const filterChip = document.getElementById('filter-chip').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filter-status').value;
            
            // Filter borrowings
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let filtered = borrowings.filter(b => {
                // Filter by employee
                if (filterEmployee) {
                    const employee = employees.find(e => e.id === b.employeeId);
                    if (!employee) return false;
                    const employeeMatch = employee.name.toLowerCase().includes(filterEmployee) || 
                                        employee.employeeNumber.toLowerCase().includes(filterEmployee);
                    if (!employeeMatch) return false;
                }
                
                // Filter by department
                if (filterDepartment) {
                    const employee = employees.find(e => e.id === b.employeeId);
                    if (!employee || !employee.department) return false;
                    if (!employee.department.toLowerCase().includes(filterDepartment)) return false;
                }
                
                // Filter by chip
                if (filterChip) {
                    const hasChip = b.chips.some(chipId => {
                        const chip = chips.find(c => c.id === chipId);
                        return chip && chip.identifier.toLowerCase().includes(filterChip);
                    });
                    if (!hasChip) return false;
                }
                
                // Filter by status
                if (filterStatus !== 'all') {
                    const isActive = !b.endDate || new Date(b.endDate) >= today;
                    if (filterStatus === 'active' && !isActive) return false;
                    if (filterStatus === 'ended' && isActive) return false;
                }
                
                return true;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">≈Ω√°dn√© v√Ωp≈Øjƒçky neodpov√≠daj√≠ zadan√Ωm filtr≈Øm.</div>';
                return;
            }
            
            // Sort by start date, newest first
            const sorted = [...filtered].sort((a, b) => 
                new Date(b.startDate) - new Date(a.startDate)
            );
            
            const getPluralForm = (count) => {
                if (count === 1) return 'v√Ωp≈Øjƒçka';
                if (count >= 2 && count <= 4) return 'v√Ωp≈Øjƒçky';
                return 'v√Ωp≈Øjƒçek';
            };
            
            const resultCount = filtered.length === borrowings.length 
                ? `Celkem ${borrowings.length} ${getPluralForm(borrowings.length)}`
                : `Zobrazeno ${filtered.length} z ${borrowings.length} ${getPluralForm(borrowings.length)}`;
            
            const table = `
                <div style="margin-bottom: 10px; color: var(--text-gray); font-size: 14px;">
                    ${resultCount}
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Zamƒõstnanec</th>
                            <th>Odbor</th>
                            <th>ƒåipy</th>
                            <th>Zaƒç√°tek</th>
                            <th>Konec</th>
                            <th>Stav</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sorted.map(b => {
                            const employee = employees.find(e => e.id === b.employeeId);
                            const chipList = b.chips.map(chipId => {
                                const chip = chips.find(c => c.id === chipId);
                                return chip ? chip.identifier : 'N/A';
                            }).join(', ');
                            
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const isActive = !b.endDate || new Date(b.endDate) >= today;
                            
                            return `
                                <tr>
                                    <td>${employee ? `${employee.name} (${employee.employeeNumber})` : 'N/A'}</td>
                                    <td>${employee && employee.department ? employee.department : '-'}</td>
                                    <td>${chipList}</td>
                                    <td>${formatDate(b.startDate)}</td>
                                    <td>${b.endDate ? formatDate(b.endDate) : '-'}</td>
                                    <td>
                                        <span class="status-badge ${isActive ? 'status-active' : 'status-returned'}">
                                            ${isActive ? 'Aktivn√≠' : 'Ukonƒçeno'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="actions">
                                            ${isActive ? `<button class="btn btn-success btn-small" onclick="endBorrowing(${b.id})">Ukonƒçit</button>` : ''}
                                            <button class="btn btn-primary btn-small" onclick="editBorrowing(${b.id})">Upravit</button>
                                            <button class="btn btn-danger btn-small" onclick="deleteBorrowing(${b.id})">Smazat</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('cs-CZ');
        }

        async function deleteBorrowing(id) {
            if (!await CustomDialog.confirm('Opravdu chcete smazat tuto v√Ωp≈Øjƒçku?')) return;
            
            borrowings = borrowings.filter(b => b.id !== id);
            Storage.set('borrowings', borrowings);
            renderBorrowings();
        }

        async function exportBorrowingsList() {
            if (borrowings.length === 0) {
                await CustomDialog.alert('Nejsou ≈æ√°dn√© v√Ωp≈Øjƒçky k exportu.');
                return;
            }
            
            const data = borrowings.map(b => {
                const employee = employees.find(e => e.id === b.employeeId);
                const chipIdentifiers = b.chips.map(chipId => {
                    const chip = chips.find(c => c.id === chipId);
                    return chip ? chip.identifier : '';
                }).filter(id => id).join(', ');
                
                return {
                    'Zamƒõstnaneck√© ƒç√≠slo': employee ? employee.employeeNumber : '',
                    'Jm√©no zamƒõstnance': employee ? employee.name : '',
                    'Odbor': employee ? (employee.department || '') : '',
                    'ƒåipy': chipIdentifiers,
                    'Datum zaƒç√°tku': b.startDate,
                    'Datum konce': b.endDate || ''
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'V√Ωp≈Øjƒçky');
            XLSX.writeFile(wb, 'vypujcky_vse.xlsx');
            Analytics.track('borrowings_list_exported', { count: borrowings.length });
        }

        function handleBorrowingsImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    let imported = 0;
                    let skipped = 0;
                    
                    rows.forEach(row => {
                        // Get employee number
                        const empNumber = String(row['Zamƒõstnaneck√© ƒç√≠slo'] || row['Zamestnanecke cislo'] || '').trim();
                        if (!empNumber) {
                            skipped++;
                            return;
                        }
                        
                        // Find employee
                        const employee = employees.find(e => e.employeeNumber === empNumber);
                        if (!employee) {
                            skipped++;
                            return;
                        }
                        
                        // Get chip identifiers
                        const chipIdentifiersStr = String(row['ƒåipy'] || row['Cipy'] || '').trim();
                        if (!chipIdentifiersStr) {
                            skipped++;
                            return;
                        }
                        
                        // Split by comma and find chip IDs
                        const chipIdentifiers = chipIdentifiersStr.split(',').map(s => s.trim()).filter(s => s);
                        const chipIds = [];
                        
                        chipIdentifiers.forEach(identifier => {
                            const chip = chips.find(c => c.identifier === identifier);
                            if (chip) {
                                chipIds.push(chip.id);
                            }
                        });
                        
                        if (chipIds.length === 0) {
                            skipped++;
                            return;
                        }
                        
                        // Get dates
                        const startDate = row['Datum zaƒç√°tku'] || row['Datum zacatku'] || '';
                        if (!startDate) {
                            skipped++;
                            return;
                        }
                        
                        const endDate = row['Datum konce'] || '';
                        
                        // Create borrowing
                        const borrowing = {
                            id: Date.now() + imported,
                            employeeId: employee.id,
                            chips: chipIds,
                            startDate: startDate,
                            endDate: endDate || null
                        };
                        
                        borrowings.push(borrowing);
                        imported++;
                    });
                    
                    Storage.set('borrowings', borrowings);
                    renderBorrowings();
                    Analytics.track('borrowings_imported', { count: imported, skipped: skipped });
                    
                    let message = `Importov√°no ${imported} v√Ωp≈Øjƒçek.`;
                    if (skipped > 0) {
                        message += ` P≈ôeskoƒçeno ${skipped} ≈ô√°dk≈Ø (chybƒõj√≠c√≠ data nebo neexistuj√≠c√≠ zamƒõstnanec/ƒçip).`;
                    }
                    await CustomDialog.alert(message);
                } catch (error) {
                    await CustomDialog.alert('Chyba p≈ôi importu souboru: ' + error.message, 'Chyba');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        async function endBorrowing(id) {
            if (!await CustomDialog.confirm('Opravdu chcete ukonƒçit tuto v√Ωp≈Øjƒçku?')) return;
            
            const borrowing = borrowings.find(b => b.id === id);
            if (!borrowing) return;
            
            // Set end date to today
            const today = new Date();
            borrowing.endDate = today.toISOString().split('T')[0];
            
            Storage.set('borrowings', borrowings);
            Analytics.track('borrowing_ended', { borrowingId: id });
            renderBorrowings();
        }

        // Edit Borrowing
        let editSelectedChipIds = [];

        function editBorrowing(id) {
            const borrowing = borrowings.find(b => b.id === id);
            if (!borrowing) return;
            
            const employee = employees.find(e => e.id === borrowing.employeeId);
            
            document.getElementById('edit-borrowing-id').value = borrowing.id;
            document.getElementById('edit-employee-search').value = employee ? `${employee.name} (${employee.employeeNumber}) - ${employee.department || 'Bez odboru'}` : '';
            document.getElementById('edit-selected-employee-id').value = borrowing.employeeId;
            document.getElementById('edit-start-date').value = borrowing.startDate;
            document.getElementById('edit-end-date').value = borrowing.endDate || '';
            
            // Set min attribute for end date
            document.getElementById('edit-end-date').min = borrowing.startDate;
            
            // Setup chips
            editSelectedChipIds = [...borrowing.chips];
            const container = document.getElementById('edit-selected-chips');
            container.innerHTML = '';
            borrowing.chips.forEach(chipId => {
                const chip = chips.find(c => c.id === chipId);
                if (chip) {
                    const tag = document.createElement('div');
                    tag.className = 'chip-tag';
                    tag.innerHTML = `
                        ${chip.identifier}
                        <button type="button" onclick="removeChipFromSelection(${chipId}, this)">&times;</button>
                    `;
                    container.appendChild(tag);
                }
            });
            
            // Setup autocomplete for edit modal
            setupEditAutocomplete(borrowing.id);
            
            document.getElementById('edit-modal').classList.add('active');
        }

        function setupEditAutocomplete(borrowingId) {
            // Employee autocomplete
            setupAutocomplete(
                'edit-employee-search',
                'edit-employee-suggestions',
                'edit-selected-employee-id',
                (value) => employees
                    .filter(e => 
                        e.name.toLowerCase().includes(value) || 
                        e.employeeNumber.toLowerCase().includes(value) ||
                        (e.department && e.department.toLowerCase().includes(value))
                    )
                    .map(e => ({ id: e.id, display: `${e.name} (${e.employeeNumber}) - ${e.department || 'Bez odboru'}` })),
                null
            );
            
            // Chip autocomplete
            const chipSearchInput = document.getElementById('edit-chip-search');
            const chipSuggestionsEl = document.getElementById('edit-chip-suggestions');
            const selectedChipsContainer = document.getElementById('edit-selected-chips');
            
            // Remove old listeners
            const newChipSearchInput = chipSearchInput.cloneNode(true);
            chipSearchInput.parentNode.replaceChild(newChipSearchInput, chipSearchInput);
            
            document.getElementById('edit-chip-search').addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();
                const startDate = document.getElementById('edit-start-date').value;
                const endDate = document.getElementById('edit-end-date').value || startDate;
                
                if (value.length === 0) {
                    chipSuggestionsEl.innerHTML = '';
                    chipSuggestionsEl.style.display = 'none';
                    return;
                }
                
                const availableChips = getAvailableChips(startDate, endDate, editSelectedChipIds, borrowingId);
                const filtered = availableChips.filter(c => 
                    c.identifier.toLowerCase().includes(value) && 
                    !editSelectedChipIds.includes(c.id)
                );
                
                if (filtered.length === 0) {
                    chipSuggestionsEl.innerHTML = '';
                    chipSuggestionsEl.style.display = 'none';
                    return;
                }
                
                chipSuggestionsEl.innerHTML = filtered.map(chip => 
                    `<div class="autocomplete-suggestion" data-id="${chip.id}">${chip.identifier}</div>`
                ).join('');
                chipSuggestionsEl.style.display = 'block';
                
                chipSuggestionsEl.querySelectorAll('.autocomplete-suggestion').forEach(el => {
                    el.addEventListener('click', () => {
                        const chipId = parseInt(el.dataset.id);
                        addChipToEditSelection(chipId);
                        document.getElementById('edit-chip-search').value = '';
                        chipSuggestionsEl.style.display = 'none';
                    });
                });
            });
        }

        function addChipToEditSelection(chipId) {
            if (editSelectedChipIds.includes(chipId)) return;
            
            editSelectedChipIds.push(chipId);
            const chip = chips.find(c => c.id === chipId);
            const container = document.getElementById('edit-selected-chips');
            
            const tag = document.createElement('div');
            tag.className = 'chip-tag';
            tag.innerHTML = `
                ${chip.identifier}
                <button type="button" onclick="removeChipFromSelection(${chipId}, this)">&times;</button>
            `;
            container.appendChild(tag);
        }

        // Date validation for edit form
        const editStartDateInput = document.getElementById('edit-start-date');
        const editEndDateInput = document.getElementById('edit-end-date');
        
        // Update min attribute on end date when start date changes
        editStartDateInput.addEventListener('change', () => {
            if (editStartDateInput.value) {
                editEndDateInput.min = editStartDateInput.value;
                // Clear end date if it's now invalid
                if (editEndDateInput.value && new Date(editEndDateInput.value) < new Date(editStartDateInput.value)) {
                    editEndDateInput.value = '';
                }
            }
        });
        
        editEndDateInput.addEventListener('change', async () => {
            if (editStartDateInput.value && editEndDateInput.value) {
                if (new Date(editEndDateInput.value) < new Date(editStartDateInput.value)) {
                    await CustomDialog.alert('Datum konce mus√≠ b√Ωt stejn√© nebo pozdƒõj≈°√≠ ne≈æ datum zaƒç√°tku.');
                    editEndDateInput.value = '';
                }
            }
        });

        document.getElementById('edit-borrowing-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-borrowing-id').value);
            const employeeId = parseInt(document.getElementById('edit-selected-employee-id').value);
            const startDate = document.getElementById('edit-start-date').value;
            const endDate = document.getElementById('edit-end-date').value || null;
            
            if (!employeeId) {
                await CustomDialog.alert('Vyberte zamƒõstnance.');
                return;
            }
            
            if (editSelectedChipIds.length === 0) {
                await CustomDialog.alert('P≈ôidejte alespo≈à jeden ƒçip.');
                return;
            }
            
            if (endDate && new Date(endDate) < new Date(startDate)) {
                await CustomDialog.alert('Datum konce mus√≠ b√Ωt stejn√© nebo pozdƒõj≈°√≠ ne≈æ datum zaƒç√°tku.');
                return;
            }
            
            const index = borrowings.findIndex(b => b.id === id);
            if (index !== -1) {
                borrowings[index] = {
                    id: id,
                    employeeId: employeeId,
                    chips: [...editSelectedChipIds],
                    startDate: startDate,
                    endDate: endDate
                };
                
                Storage.set('borrowings', borrowings);
                Analytics.track('borrowing_updated', { borrowingId: id });
                closeEditModal();
                renderBorrowings();
            }
        });

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            document.getElementById('edit-borrowing-form').reset();
            document.getElementById('edit-end-date').min = '';
            editSelectedChipIds = [];
        }

        // Export functionality
        function initializeExport() {
            document.getElementById('export-borrowings').addEventListener('click', exportBorrowings);
        }

        async function exportBorrowings() {
            const monthInput = document.getElementById('export-month').value;
            if (!monthInput) {
                await CustomDialog.alert('Vyberte mƒõs√≠c pro export.');
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            
            const exportData = [];
            
            // For each borrowing
            borrowings.forEach((borrowing, borrowingIndex) => {
                const employee = employees.find(e => e.id === borrowing.employeeId);
                if (!employee) return;
                
                const bStart = new Date(borrowing.startDate);
                const bEnd = borrowing.endDate ? new Date(borrowing.endDate) : new Date();
                
                // Check if borrowing overlaps with selected month
                if (bStart > endDate || bEnd < startDate) return;
                
                // For each chip in borrowing
                borrowing.chips.forEach(chipId => {
                    const chip = chips.find(c => c.id === chipId);
                    if (!chip) return;
                    
                    // For each day in the month where chip was borrowed
                    let currentDate = new Date(Math.max(bStart, startDate));
                    const lastDate = new Date(Math.min(bEnd, endDate));
                    
                    while (currentDate <= lastDate) {
                        const day = currentDate.getDate();
                        const monthNum = currentDate.getMonth() + 1;
                        const yearNum = currentDate.getFullYear();
                        
                        exportData.push({
                            borrowingIndex: borrowingIndex,
                            borrowingId: borrowing.id,
                            chipId: chipId,
                            chipIdentifier: chip.identifier,
                            date: new Date(currentDate),
                            dateFormatted: `${day}/${monthNum}/${yearNum}`,
                            employeeNumber: employee.employeeNumber,
                            employeeName: employee.name,
                            department: employee.department || ''
                        });
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                });
            });
            
            if (exportData.length === 0) {
                await CustomDialog.alert('Pro vybran√Ω mƒõs√≠c nejsou ≈æ√°dn√© v√Ωp≈Øjƒçky.');
                return;
            }
            
            // Sort by borrowing, then chip, then date
            exportData.sort((a, b) => {
                // First by borrowing ID
                if (a.borrowingId !== b.borrowingId) {
                    return a.borrowingId - b.borrowingId;
                }
                // Then by chip identifier
                const chipCompare = a.chipIdentifier.localeCompare(b.chipIdentifier);
                if (chipCompare !== 0) return chipCompare;
                // Finally by date
                return a.date - b.date;
            });
            
            // Create worksheet data with header row
            const wsData = [];
            
            // First row: merged cells with title
            wsData.push([`Zap≈Øjƒçen√≠ ƒçip≈Ø na plav√°n√≠ - ${year}/${month}`]);
            
            // Second row: column headers
            wsData.push(['ƒå√≠slo ƒçipu', 'Osobn√≠ ƒç√≠slo', 'Jm√©no', 'Odbor', 'Datum v√Ωp≈Øjƒçky']);
            
            // Data rows
            exportData.forEach(row => {
                wsData.push([
                    row.chipIdentifier,
                    row.employeeNumber,
                    row.employeeName,
                    row.department,
                    row.dateFormatted
                ]);
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Merge first row (title) across all columns
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push({
                s: { r: 0, c: 0 }, // start: row 0, column 0
                e: { r: 0, c: 4 }  // end: row 0, column 4 (5 columns total)
            });
            
            // Style the title cell (bold and centered)
            if (!ws['A1'].s) ws['A1'].s = {};
            ws['A1'].s = {
                font: { bold: true, sz: 14 },
                alignment: { horizontal: 'center', vertical: 'center' }
            };
            
            // Set column widths
            ws['!cols'] = [
                { wch: 15 }, // ƒå√≠slo ƒçipu
                { wch: 15 }, // Osobn√≠ ƒç√≠slo
                { wch: 25 }, // Jm√©no
                { wch: 20 }, // Odbor
                { wch: 15 }  // Datum v√Ωp≈Øjƒçky
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'V√Ωp≈Øjƒçky');
            XLSX.writeFile(wb, `vypujcky_${year}-${String(month).padStart(2, '0')}.xlsx`);
            Analytics.track('borrowings_exported_xlsx', { month: monthInput, rowCount: exportData.length });
        }

        // Data Management
        function initializeDataManagement() {
            // Export all data
            document.getElementById('export-all-data').addEventListener('click', exportAllData);
            
            // Import all data
            document.getElementById('import-all-data-btn').addEventListener('click', () => {
                document.getElementById('import-all-data').click();
            });
            document.getElementById('import-all-data').addEventListener('change', handleImportAllData);
            
            // Delete all data
            document.getElementById('delete-all-data').addEventListener('click', deleteAllData);
            
            // Update stats and months
            updateDataStats();
            updateMonthsOverview();
        }

        function updateDataStats() {
            document.getElementById('stats-chips').textContent = chips.length;
            document.getElementById('stats-employees').textContent = employees.length;
            document.getElementById('stats-borrowings').textContent = borrowings.length;
        }

        function getMonthsWithBorrowings() {
            const monthsSet = new Set();
            
            borrowings.forEach(b => {
                const startDate = new Date(b.startDate);
                const endDate = b.endDate ? new Date(b.endDate) : new Date();
                
                // Add all months between start and end date
                let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
                const lastDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
                
                while (currentDate <= lastDate) {
                    const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                    monthsSet.add(monthKey);
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
            });
            
            // Convert to array and sort descending (newest first)
            return Array.from(monthsSet).sort().reverse();
        }

        function updateMonthsOverview() {
            const container = document.getElementById('months-overview');
            const months = getMonthsWithBorrowings();
            
            if (months.length === 0) {
                container.innerHTML = '<div style="color: var(--text-gray); font-style: italic;">Nejsou ≈æ√°dn√© v√Ωp≈Øjƒçky.</div>';
                return;
            }
            
            const monthNames = [
                'leden', '√∫nor', 'b≈ôezen', 'duben', 'kvƒõten', 'ƒçerven',
                'ƒçervenec', 'srpen', 'z√°≈ô√≠', '≈ô√≠jen', 'listopad', 'prosinec'
            ];
            
            let html = '<div style="display: grid; gap: 10px;">';
            
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = monthNames[parseInt(month) - 1];
                
                // Count borrowings for this month
                const count = countBorrowingsInMonth(monthKey);
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border: 1px solid var(--border-color); border-radius: 6px;">
                        <div>
                            <strong style="font-size: 16px;">${monthName} ${year}</strong>
                            <div style="font-size: 13px; color: var(--text-gray); margin-top: 3px;">
                                ${count} ${count === 1 ? 'v√Ωp≈Øjƒçka' : count >= 2 && count <= 4 ? 'v√Ωp≈Øjƒçky' : 'v√Ωp≈Øjƒçek'}
                            </div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteMonthBorrowings('${monthKey}', '${monthName} ${year}')">
                            Smazat
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function countBorrowingsInMonth(monthKey) {
            const [year, month] = monthKey.split('-').map(Number);
            const monthStart = new Date(year, month - 1, 1);
            const monthEnd = new Date(year, month, 0, 23, 59, 59);
            
            return borrowings.filter(b => {
                const bStart = new Date(b.startDate);
                const bEnd = b.endDate ? new Date(b.endDate) : new Date();
                
                // Check if borrowing overlaps with this month
                return bStart <= monthEnd && bEnd >= monthStart;
            }).length;
        }

        async function deleteMonthBorrowings(monthKey, monthName) {
            const count = countBorrowingsInMonth(monthKey);
            
            if (!await CustomDialog.confirm(`Opravdu chcete smazat v≈°echny v√Ωp≈Øjƒçky z mƒõs√≠ce ${monthName}?\n\nBude smaz√°no ${count} ${count === 1 ? 'v√Ωp≈Øjƒçka' : count >= 2 && count <= 4 ? 'v√Ωp≈Øjƒçky' : 'v√Ωp≈Øjƒçek'}.\n\nTuto akci nelze vr√°tit zpƒõt!`)) {
                return;
            }
            
            const [year, month] = monthKey.split('-').map(Number);
            const monthStart = new Date(year, month - 1, 1);
            const monthEnd = new Date(year, month, 0, 23, 59, 59);
            
            // Filter out borrowings that overlap with this month
            borrowings = borrowings.filter(b => {
                const bStart = new Date(b.startDate);
                const bEnd = b.endDate ? new Date(b.endDate) : new Date();
                
                // Keep borrowing if it does NOT overlap with this month
                return !(bStart <= monthEnd && bEnd >= monthStart);
            });
            
            Storage.set('borrowings', borrowings);
            renderBorrowings();
            updateDataStats();
            updateMonthsOverview();
            
            Analytics.track('month_borrowings_deleted', { month: monthKey, count: count });
            await CustomDialog.alert(`Bylo smaz√°no ${count} ${count === 1 ? 'v√Ωp≈Øjƒçka' : count >= 2 && count <= 4 ? 'v√Ωp≈Øjƒçky' : 'v√Ωp≈Øjƒçek'} z mƒõs√≠ce ${monthName}.`);
        }

        async function exportAllData() {
            const allData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                chips: chips,
                employees: employees,
                borrowings: borrowings
            };
            
            // Create filename with timestamp
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const filename = `evidence-plavenek-${yyyy}-${mm}-${dd}-${hh}${min}.json`;
            
            // Create and download file
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            Analytics.track('all_data_exported', { chips: chips.length, employees: employees.length, borrowings: borrowings.length });
            await CustomDialog.alert('Data byla √∫spƒõ≈°nƒõ exportov√°na.');
        }

        async function handleImportAllData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!await CustomDialog.confirm('VAROV√ÅN√ç: Import dat p≈ôep√≠≈°e v≈°echna souƒçasn√° data v aplikaci. Opravdu chcete pokraƒçovat?')) {
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.chips || !importedData.employees || !importedData.borrowings) {
                        await CustomDialog.alert('Chyba: Neplatn√Ω form√°t souboru. Soubor neobsahuje v≈°echna po≈æadovan√° data.', 'Chyba');
                        return;
                    }
                    
                    // Import data
                    chips = importedData.chips || [];
                    employees = importedData.employees || [];
                    borrowings = importedData.borrowings || [];
                    
                    // Save to localStorage
                    Storage.set('chips', chips);
                    Storage.set('employees', employees);
                    Storage.set('borrowings', borrowings);
                    
                    // Refresh all displays
                    renderChips();
                    renderEmployees();
                    renderBorrowings();
                    updateDataStats();
                    updateMonthsOverview();
                    
                    Analytics.track('all_data_imported', { chips: chips.length, employees: employees.length, borrowings: borrowings.length });
                    await CustomDialog.alert(`Data byla √∫spƒõ≈°nƒõ importov√°na!\n\nƒåipy: ${chips.length}\nZamƒõstnanci: ${employees.length}\nV√Ωp≈Øjƒçky: ${borrowings.length}`);
                } catch (error) {
                    await CustomDialog.alert('Chyba p≈ôi importu dat: ' + error.message, 'Chyba');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        async function deleteAllData() {
            const confirmation = await CustomDialog.prompt('VAROV√ÅN√ç: Tato akce sma≈æe √∫plnƒõ v≈°echna data!\n\nPro potvrzen√≠ napi≈°te "SMAZAT" (bez uvozovek):', '', 'Varov√°n√≠');
            
            if (confirmation !== 'SMAZAT') {
                await CustomDialog.alert('Maz√°n√≠ bylo zru≈°eno.');
                return;
            }
            
            // Clear data
            chips = [];
            employees = [];
            borrowings = [];
            
            // Clear localStorage
            Storage.set('chips', []);
            Storage.set('employees', []);
            Storage.set('borrowings', []);
            
            // Refresh all displays
            renderChips();
            renderEmployees();
            renderBorrowings();
            updateDataStats();
            updateMonthsOverview();
            
            await CustomDialog.alert('V≈°echna data byla smaz√°na.');
        }

        // Help/Documentation
        let helpContentLoaded = false;
        
        async function loadHelpContent() {
            if (helpContentLoaded) return;
            
            Analytics.track('help_viewed');
            const container = document.getElementById('help-content');
            
            // Configure marked options
            marked.setOptions({
                breaks: true,
                gfm: true
            });
            
            try {
                // Try to fetch README.md from file
                const response = await fetch('README.md');
                if (!response.ok) {
                    throw new Error('README.md not found');
                }
                
                const markdown = await response.text();
                const html = marked.parse(markdown);
                container.innerHTML = html;
                helpContentLoaded = true;
            } catch (error) {
                console.log('Naƒç√≠t√°n√≠ README.md selhalo (bƒõ≈æ√≠ z file://)');
                
                // Show information about README.md file location
                container.innerHTML = `
                    <div style="max-width: 700px; margin: 40px auto; padding: 30px; background: var(--bg-gray); border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <span style="font-size: 48px;">üìñ</span>
                        </div>
                        <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">Dokumentace aplikace</h2>
                        <p style="color: var(--text-gray); margin-bottom: 20px; text-align: center;">
                            Kompletn√≠ n√°povƒõda k aplikaci je dostupn√° v souboru <strong>README.md</strong>, kter√Ω se nach√°z√≠ ve stejn√© slo≈æce jako tato aplikace.
                        </p>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #1f2937;">üí° Jak zobrazit n√°povƒõdu v aplikaci:</h3>
                            <ol style="color: var(--text-gray); line-height: 1.8; padding-left: 20px;">
                                <li>Spus≈•te aplikaci p≈ôes lok√°ln√≠ webserver (nap≈ô. <code style="background: var(--bg-gray); padding: 2px 6px; border-radius: 3px;">python -m http.server</code>)</li>
                                <li>Nebo otev≈ôete soubor <strong>README.md</strong> v libovoln√©m textov√©m editoru nebo prohl√≠≈æeƒçi</li>
                            </ol>
                        </div>

                        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>‚ÑπÔ∏è Proƒç to nefunguje:</strong> Kv≈Øli bezpeƒçnostn√≠m omezen√≠m prohl√≠≈æeƒçe nelze naƒç√≠tat extern√≠ soubory (jako README.md) p≈ôi spu≈°tƒõn√≠ aplikace ze souboru (file://).
                            </p>
                        </div>

                        <div style="text-align: center;">
                            <a href="README.md" target="_blank" class="btn btn-primary" style="display: inline-block; text-decoration: none; color: white;">
                                üìÑ Otev≈ô√≠t README.md v nov√© z√°lo≈æce
                            </a>
                        </div>
                    </div>
                `;
                helpContentLoaded = true;
            }
        }
    </script>
</body>
</html>
